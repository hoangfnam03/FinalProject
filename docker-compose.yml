version: '3.8'
services:
  # ========== 1. SQL Server ==========
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: qna_db
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "Sa123456!"
    ports:
      - "1436:1433"          # ĐỔI: host 1436 -> container 1433, tránh trùng SQL máy
    volumes:
      - sql_data:/var/opt/mssql
    networks:
      - qna_network

  # 2. Backend (.NET)
  backend:
    build:
      context: .             # build từ FinalProject
      dockerfile: Dockerfile # Dockerfile của BE
    container_name: qna_backend
    ports:
      - "7006:7006"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:7006
      # Key phải trùng ConnectionStrings:DefaultConnection trong appsettings
      - ConnectionStrings__DefaultConnection=Server=db,1433;Database=QnA;User Id=sa;Password=Sa123456!;TrustServerCertificate=True;
    depends_on:
      - db-migrator
    networks:
      - qna_network
    restart: unless-stopped

  # 3. Frontend (Nginx)
  frontend:
    build:
      context: ./QnA_FE
      dockerfile: Dockerfile
    container_name: qna_frontend
    depends_on:
      - backend
    ports:
      - "3000:80"
    networks:
      - qna_network
    
  db-migrator:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    container_name: qna-db-migrator
    volumes:
      - .:/src
    working_dir: /src
    depends_on:
      - db
    networks:
      - qna_network
    environment:
      - ConnectionStrings__DefaultConnection=Server=db,1433;Database=QnA;User Id=sa;Password=Sa123456!;TrustServerCertificate=True;
    command: >
      /bin/bash -c "
      echo '--- Waiting for DB to be ready ---' &&
      for i in {1..60}; do
        if timeout 2 bash -c 'cat < /dev/null > /dev/tcp/db/1433' 2>/dev/null; then
          echo '--- DB port is open, testing connection ---' &&
          sleep 5 &&
          break
        fi
        echo 'DB is not ready yet, waiting... (attempt $$i/60)' &&
        sleep 2
      done &&
      echo '--- Installing dotnet-ef ---' &&
      dotnet tool install --global dotnet-ef --version 8.0.10 || true &&
      export PATH=\"$$PATH:/root/.dotnet/tools\" &&
      echo '--- Creating database using EF (if not exists) ---' &&
      dotnet-ef database update --project Infrastructure/Infrastructure.csproj --startup-project QnA_BE/QnA_BE.csproj --connection 'Server=db,1433;Database=master;User Id=sa;Password=Sa123456!;TrustServerCertificate=True;' --context ApplicationDbContext --no-build 2>/dev/null || true &&
      echo '--- Running migration ---' &&
      dotnet-ef database update --project Infrastructure/Infrastructure.csproj --startup-project QnA_BE/QnA_BE.csproj --verbose &&
      echo '=== MIGRATION DONE ==='
      "

volumes:
  sql_data:

networks:
  qna_network:
    driver: bridge
